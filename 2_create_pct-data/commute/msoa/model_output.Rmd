---
title: "Propensity to Cycle Tool - local results"
author: "Created by the PCT team"
output:
  html_document:
    fig_caption: yes
    highlight: pygments
    theme: null
    toc: yes
---

```{r, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(message = FALSE)

# Set relative starting path for route directory
root <- "../../.."

# Read-in the data
if(!exists("region")) region <- "london"
zones <- readRDS(file.path(root, pct_data, purpose, geography, region, "z.Rds"))
cents <- readRDS(file.path(root, pct_data, purpose, geography, region, "c.Rds"))
l <- readRDS(file.path(root, pct_data, purpose, geography, region, "l.Rds"))
rf <- readRDS(file.path(root, pct_data, purpose, geography, region, "rf.Rds"))
rq <- readRDS(file.path(root, pct_data, purpose, geography, region, "rq.Rds"))
dfscen <- dplyr::select(l@data, contains("slc"), -contains("co2"), all, olc = bicycle, dist_fast)
dfsp <- gather(dfscen, key = scenario, value = slc, -dist_fast)
dfsp$scenario <- factor(dfsp$scenario)
dfsp$scenario <-
  factor(dfsp$scenario, levels = levels(dfsp$scenario)[c(1, 3, 2, 4, 5, 6)])
levels(dfsp$scenario)[1] <- c("Total no. commuters")
levels(dfsp$scenario)[6] <- c("Cyclists in Census 2011")

las_in_region <- gIntersects(las_cents, region_shape, byid = T)
las_in_region <- las_in_region[1,]
las_in_region <- las[las_in_region,]

for (i in 1:length(names(build_regions_params))){
  assign(names(build_regions_params)[i], build_regions_params[,i])
}
(n_extra_flow <- n_flow_inter_regional - n_flow)
(n_extra_people <- n_people_inter_regional - n_people)

```

## Key information 

This document provides information about the data underlying the Propensity to Cycle Tool (PCT) for `r capitalize_region(region)`. The data were generated on `r build_date` and this document was created on `r Sys.Date()`. The PCT is an open source tool for sustainable transport planning, released under the conditions of the 
<a target="_blank" href="https://www.gnu.org/licenses/agpl-3.0">Affero GPL</a>. Both the <a target="_blank" href="https://github.com/npct/pct">pct</a> and <a target="_blank" href="https://github.com/npct/pct">pct-shiny</a> can be modified by others as long as attribution is made to the original.

This version of the PCT uses origin-destination (OD) data on travel to work from the 2011 Census. The dataset reports the number of people travelling by different modes from Middle Super Output Area zones (<a target = "_black" href = "https://data.gov.uk/dataset/middle-layer-super-output-area-msoa-boundaries">MSOA</a>, average size 3325 commuters). There were `r prettyNum(sum(zones$all), big.mark = ",", scientific = F)` commuters living in `r capitalize_region(region)` recorded in the 2011 Census. All of these are represented in the zones data produced by the PCT.

In `r capitalize_region(region)` there are `r n_flow` flows between MSOAs that a) start and end in `r capitalize_region(region)`, b) have a straight-line (Euclidean) distance of less than `r mdist`km and a fast-route distance less than 30km, and c) contain more than `r mflow` commuters (by any mode, counting commuters in both directions).   These `r n_flow` between-zone MSOA flows are visualised as **Straight Lines**, **Routes** (fast and quiet) and the **Route Network (MSOA)** on the interactive map, and account for `r round(n_people / sum(zones$all) * 100)`% of all commuters living in `r capitalize_region(region)`.  In addition, a further `r n_extra_flow` **inter-regional flows** of distance less than `r mdist`km and containing more than `r mflow` commuters are visualised as Straight Lines and Routes. These inter-regional flows contain an additional `r prettyNum(n_extra_people, big.mark = ",", scientific = F)` commuters who either live in `r capitalize_region(region)` and work outside, or work in `r capitalize_region(region)` and live outside.

Between-zone MSOA flows exclude **within-MSOA travel**, when the MSOA zone of origin is the same as the zone of destination. Within-MSOA travel is represented by red points on the map when the lines are shown, and accounts for `r round(sum(cents$all) / sum(zones$all) * 100)`% of commuters in `r capitalize_region(region)`. The between-zone MSOA flows visualised as lines and routes on the map also exclude commuters travelling outside `r capitalize_region(region)` and people with no fixed place of work.

A **Route Network (LSOA)** is also available, to complement the MSOA-level lines, routes and route network.  This LSOA (for Lower Super Output Area) route network includes all commuters living in `r capitalize_region(region)` and travelling <20km, except for those living and working the same LSOA or having no fixed place of work.  Unlike the MSOA route network, the LSOA route network includes commuters living in `r capitalize_region(region)` but working in another region within England. For more details please see User Manual C.

See <a target="_blank" href="https://www.jtlu.org/index.php/jtlu/article/view/862">Lovelace et al. (2017)</a> for details of the methods used to estimate the cycling, health and carbon impacts of each scenario, and to visualise results at the area, line, route and route network level.

## The `r capitalize_region(region)` region

<!-- Can we show hilliness by comparison to other areas?  -->

```{r distance-dist, echo=FALSE, fig.cap="", echo=FALSE, message=FALSE, warning=FALSE}
plot(zones, col = "lightgrey")
plot(regions, add = T)
plot(las_in_region, border = "blue", add = T, lwd = 2)
plot(regions, lwd = 5, add = T)
lines(l[l$all > 100,], col = "green")
```

**Figure 1:** Map of the PCT region (thick black border), local authority boundaries (blue line) and zones in the region (grey with a black border). The straight green lines represent the 100 flows with the greatest number of commuters by any mode.

The map below shows the average hilliness of the between-zone routes used by commuters living in each MSOA.
The average hilliness of the fastest routes in
`r capitalize_region(region)` is
`r round(100 * mean(rf$av_incline, na.rm = T), 2)`%,
compared with a national average of
`r round(100 * mean(rf_nat$av_incline, na.rm = T), 2)`%.


```{r, echo = FALSE, fig.cap=""}
tm_shape(zones) +
  tm_fill("avslope_perc", n = 3, palette = "Oranges", title = "Average gradient\nof fast routes (%)") +
  tm_legend()
```

**Figure 2:** Map showing the average hilliness of routes in zones across the study area.

## Cycling levels in each scenario for `r capitalize_region(region)`

The proportion of people who cycled as their main mode of travel to work baseline (2011 Census) data in `r capitalize_region(region)` was 
`r round(100 * sum(zones$bicycle) / sum(zones$all) , 1)`%, compared to the national average of 3.2%.
The percentage of cycling expected, based on the distance and hilliness of commutes in the region using the baseline model for England, was
`r round(100 * (sum(zones$govtarget_slc) - sum(zones$bicycle)) / sum(zones$all) , 1)`%.


Summary results for the proportion of people walking, driving and using other modes under each scenario are illustrated in **Table 1**  below.

| Scenario | % cyclists | % walking | % car drivers | % all other modes |
| ------------- |:-------------: |:-------------: |:--------------:| :----------------: |
| Census 2011 | `r paste(sprintf('%.1f', (b <- round(100 * sum(zones$bicycle) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (f <- round(100 * sum(zones$foot) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (cd <- round(100 * sum(zones$car_driver) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (100 - b - f - cd)), '%')` |
| Government Target | `r paste(sprintf('%.1f', (b <- round(100 * sum(zones$govtarget_slc) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (f <- round(100 * sum(zones$govtarget_slw) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (cd <- round(100 * sum(zones$govtarget_sld) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (100 - b - f - cd)), '%')` |
| Gender Equity | `r paste(sprintf('%.1f', (b <- round(100 * sum(zones$gendereq_slc) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (f <- round(100 * sum(zones$gendereq_slw) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (cd <- round(100 * sum(zones$gendereq_sld) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (100 - b - f - cd)), '%')` |
| Go Dutch | `r paste(sprintf('%.1f', (b <- round(100 * sum(zones$dutch_slc) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (f <- round(100 * sum(zones$dutch_slw) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (cd <- round(100 * sum(zones$dutch_sld) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (100 - b - f - cd)), '%')` |
| Ebikes  | `r paste(sprintf('%.1f', (b <- round(100 * sum(zones$ebike_slc) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (f <- round(100 * sum(zones$ebike_slw) / sum(zones$all) , 1))), '%')`|`r paste(sprintf('%.1f', (cd <- round(100 * sum(zones$ebike_sld) / sum(zones$all) , 1))), '%')` | `r paste(sprintf('%.1f', (100 - b - f - cd)), '%')` |


<br><br>

Figure 3 illustrates the overall number of people in between-zone MSOA flows cycling to work under each scenario (note that this does not include within-MSOA travel).

<!--Anna note I think we Ideally should revisit this figure at some point and include within-zone flows, I think it would make the figure much more helpful-->
```{r, echo=FALSE, warning=FALSE, fig.cap=""}
levels(dfsp$scenario) <- gsub("_slc", "", levels(dfsp$scenario))
levels(dfsp$scenario) <- capitalize_region(levels(dfsp$scenario))
levels(dfsp$scenario)[2:5] = c("Cyclists in Ebikes", "Cyclists in Go Dutch", "Cyclists in Gender Equality", "Cyclists in Government Target")
ggplot(dfsp) +
  geom_freqpoly(aes(dist_fast, weight = slc,
    color = scenario), binwidth = 1) +
  ylab("Number of commuters") +
  xlab("Route distance (km)") +
  scale_color_discrete(name = "Scenario") +
  xlim(c(0,12)) +
  theme_bw()
```

**Figure 3:** Number of between-zone commuters within `r capitalize_region(region)` cycling by scenario and distance.


## Health and carbon impacts

A modified version of the 2014 <a target="_blank" href="http://www.euro.who.int/en/health-topics/environment-and-health/Transport-and-health/publications/2011/health-economic-assessment-tools-heat-for-walking-and-for-cycling.-methodology-and-user-guide.-economic-assessment-of-transport-infrastructure-and-policies.-2014-update">HEAT tool</a> was used to calculate health impacts, based on the extra physical activity gained through new cycling trips in each scenario, minus the physical activity displaced in any former walking trips that have now been switched to cycling. CO2 impacts are derived from changes in distance driven per scenario.

**Table 2** below illustrates the health and carbon impacts of the different scenarios.  For each scenario, comparisons are made with a counterfactual in which nobody in the region cycled ('No cyclists'), and with the observed level of cycling in the 2011 Census.

| Scenario | Comparison	| Change in deaths/year  | Value of change ( million pounds )  | Change in tonnes CO2e/year |
| -------- |:----------:|:-----------------: |:----------:| :---------------:|
| Census 2011 |	'No Cyclists' |  `r (sprintf('%.2f', round(sum(zones$govtarget_sldeath_heat) - sum(zones$govtarget_sideath_heat) , 2)))` | `r (sprintf('%.2f', round((sum(zones$govtarget_slvalue_heat) - sum(zones$govtarget_sivalue_heat)) / 1000000  , 2)))` | `r (round( ( sum(zones$govtarget_slco2) - sum(zones$govtarget_sico2) ) / 1000))` |
| Government Target |	'No Cyclists' |  `r (sprintf('%.2f', round(sum(zones$govtarget_sldeath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$govtarget_slvalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$govtarget_slco2) / 1000))` |
|  |	Census 2011 |  `r (sprintf('%.2f', round(sum(zones$govtarget_sideath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$govtarget_sivalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$govtarget_sico2) / 1000))` |
| Gender Equity |	'No Cyclists' |  `r (sprintf('%.2f', round(sum(zones$gendereq_sldeath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$gendereq_slvalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$gendereq_slco2) / 1000))` | 
|  |	Census 2011 |  `r (sprintf('%.2f', round(sum(zones$gendereq_sideath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$gendereq_sivalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$gendereq_sico2) / 1000))` |
| Go Dutch |	'No Cyclists' |  `r (sprintf('%.2f', round(sum(zones$dutch_sldeath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$dutch_slvalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$dutch_slco2) / 1000))` |
|  |	Census 2011 |  `r (sprintf('%.2f', round(sum(zones$dutch_sideath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$dutch_sivalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$dutch_sico2) / 1000))` |
| Ebikes |	'No Cyclists' |  `r (sprintf('%.2f', round(sum(zones$ebike_sldeath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$ebike_slvalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$ebike_slco2) / 1000))` |
|  |	Census 2011 |  `r (sprintf('%.2f', round(sum(zones$ebike_sideath_heat) , 2)))` | `r (sprintf('%.2f', round(sum(zones$ebike_sivalue_heat) / 1000000  , 2)))` | `r (round( sum(zones$ebike_sico2) / 1000))` |


## References

Lovelace, R., Goodman, A., Aldred, R., Berkoff, N., Abbas, A., Woodcock, J., 2017. The Propensity to Cycle Tool: An open source online system for sustainable transport planning. Journal of Transport and Land Use. 10:1, 505&ndash;528, <a target="_blank" href="https://www.jtlu.org/index.php/jtlu/article/view/862">DOI: 10.5198/jtlu.2016.862</a>
